<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <style>
      /* Your CSS styles here */
      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        padding: 20px;
      }

      .chat-messages {
        flex: 1;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
      }

      .chat-message {
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <h1>Chat</h1>
      <h2>Chatting with: <span id="friendName"></span></h2>
      <div class="chat-messages" id="chatMessages">
        <!-- Chat messages will be dynamically added here -->
      </div>
      <textarea
        id="messageInput"
        rows="3"
        placeholder="Type your message here"
      ></textarea>
      <button id="sendMessageButton">Send</button>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        getDoc,
        onSnapshot,
        doc,
        where,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDSVB_m--vKWpFjpa1PSyZoF7slhTdGN08",
        authDomain: "bookweb-99ef4.firebaseapp.com",
        databaseURL: "https://bookweb-99ef4-default-rtdb.firebaseio.com",
        projectId: "bookweb-99ef4",
        storageBucket: "bookweb-99ef4.appspot.com",
        messagingSenderId: "415676602525",
        appId: "1:415676602525:web:5ed67a9357cc9e3b88dc74",
        measurementId: "G-VDFL9E4XYJ",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth();

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const currentUserUID = user.uid;

          const urlParams = new URLSearchParams(window.location.search);
          const friendID = urlParams.get("friendID");

          if (!currentUserUID || !friendID) {
            console.error("currentUserUID or friendID is undefined.");
          } else {
            const chatMessages = document.getElementById("chatMessages");
            const friendNameSpan = document.getElementById("friendName");
            const messageInput = document.getElementById("messageInput");
            const sendMessageButton =
              document.getElementById("sendMessageButton");

            sendMessageButton.addEventListener("click", sendMessage);

            // Fetch friend's name based on friendID
            const friendDoc = await getDoc(doc(db, "users", friendID));
            if (friendDoc.exists()) {
              const friendName = friendDoc.data().name;
              friendNameSpan.textContent = friendName;
            } else {
              console.error("Friend not found.");
              return;
            }

            const chatCollectionRef = collection(db, "chats");
            const chatQuery = query(
              chatCollectionRef,
              where("participants", "array-contains", currentUserUID),
              orderBy("timestamp")
            );

            onSnapshot(chatQuery, (snapshot) => {
              const messages = [];
              snapshot.forEach((doc) => {
                const data = doc.data();
                if (data.participants.includes(friendID)) {
                  messages.push(data);
                }
              });
              renderChatMessages(messages);
            });

            async function sendMessage() {
              const text = messageInput.value.trim();
              if (text === "") return;

              try {
                await addDoc(chatCollectionRef, {
                  text: text,
                  senderID: currentUserUID,
                  timestamp: new Date(),
                  senderName: user.displayName, // Assuming user has a display name
                  participants: [currentUserUID, friendID], // Include both participants
                });
                messageInput.value = "";
              } catch (error) {
                console.error("Error sending message:", error);
              }
            }

            function renderChatMessages(messages) {
              chatMessages.innerHTML = "";
              messages.forEach((message) => {
                const messageElement = document.createElement("div");
                messageElement.textContent = `${message.senderName}: ${message.text}`;
                chatMessages.appendChild(messageElement);
              });
            }
          }
        } else {
          // If the user is not authenticated, redirect to the sign-in page
          window.location.href = "register.html";
        }
      });
    </script>
  </body>
</html>
